<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - Chat App</title>
  <link rel="stylesheet" href="/style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>ðŸ’¬ Chat</h2>
        <button id="logout-btn" class="logout-btn">Logout</button>
      </div>

      <div class="user-info">
        <img src="{{ currentUser.avatar }}" alt="{{ currentUser.username }}" class="user-avatar">
        <div class="user-details">
          <h3>{{ currentUser.username }}</h3>
          <p>{{ currentUser.email }}</p>
        </div>
      </div>

      <div class="search-box">
        <input type="text" id="search-input" placeholder="Zoek gebruikers...">
      </div>

      <!-- Chat List -->
      <div class="chat-list">
        <h3>Conversaties</h3>
        {% if chatsWithMessages.size > 0 %}
          {% for chat in chatsWithMessages %}
            <div class="chat-item" onclick="selectChat('{{ chat.chatId }}', '{{ chat.otherUser.id }}')">
              <img src="{{ chat.otherUser.avatar }}" alt="{{ chat.otherUser.username }}" class="chat-avatar">
              <div class="chat-item-info">
                <h4>{{ chat.otherUser.username }}</h4>
                <p class="last-message">{{ chat.lastMessage }}</p>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="no-chats">Nog geen conversaties</p>
        {% endif %}
      </div>

      <!-- Users List -->
      <div class="users-list">
        <h3>Start een chat</h3>
        {% if otherUsers.size > 0 %}
          {% for user in otherUsers %}
            <div class="user-item" onclick="selectChat(null, '{{ user.id }}')">
              <img src="{{ user.avatar }}" alt="{{ user.username }}" class="user-avatar">
              <div class="user-item-info">
                <h4>{{ user.username }}</h4>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="no-users">Geen andere gebruikers beschikbaar</p>
        {% endif %}
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main">
      <div id="chat-window" class="chat-window">
        <div class="empty-state">
          <h2>Selecteer een chat om te beginnen</h2>
        </div>
      </div>

      <div id="message-input-area" class="message-input-area" style="display: none;">
        <form id="message-form" onsubmit="sendMessage(event)">
          <div class="input-wrapper">
            <textarea id="message-input" name="text" placeholder="Type een bericht..." rows="1"></textarea>
            <button type="submit" class="send-btn">Verzend</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // WebSocket connection
    const socket = io()
    
    const currentUser = {
      id: '{{ currentUser.id }}',
      username: '{{ currentUser.username }}'
    };

    let selectedChatId = null;
    let selectedReceiverId = null;
    let isTyping = false;

    // Register user connection
    socket.on('connect', () => {
      console.log('âœ“ Connected to WebSocket server')
      socket.emit('user-join', currentUser.id)
    })

    // Handle incoming messages in real-time
    socket.on('message-received', (data) => {
      const { message, senderId, receiverId } = data
      
      if (selectedReceiverId === senderId) {
        // Append message to chat window if it's from the current chat
        appendMessage(message, senderId === currentUser.id)
      }
      
      // Update chat list item
      updateChatListItem(senderId, message.text)
    })

    // Handle own sent messages
    socket.on('message-sent', (data) => {
      const { message, receiverId } = data
      
      if (selectedReceiverId === receiverId) {
        // Append own message to chat window
        appendMessage(message, true)
      }
      
      // Refresh chat list to update last message
      updateChatListItem(receiverId, message.text)
    })

    // Handle chat list updates
    socket.on('chat-updated', (data) => {
      const { chatUpdate, otherUserId } = data
      updateChatListItem(otherUserId, chatUpdate.lastMessage)
    })

    // Handle messages loaded from Firebase
    socket.on('messages-loaded', (data) => {
      const { userId, messages } = data
      
      if (selectedReceiverId === userId) {
        displayMessages(messages, userId)
      }
    })

    // Handle user typing
    socket.on('user-typing', (data) => {
      const { userId } = data
      if (userId === selectedReceiverId) {
        console.log(`${userId} is typing...`)
      }
    })

    // Handle user stop typing
    socket.on('user-stop-typing', (data) => {
      const { userId } = data
      if (userId === selectedReceiverId) {
        console.log(`${userId} stopped typing`)
      }
    })

    // Handle online/offline status
    socket.on('user-online', (data) => {
      console.log(`âœ“ User ${data.userId} is now online`)
    })

    socket.on('user-offline', (data) => {
      console.log(`âš  User ${data.userId} is now offline`)
    })

    function selectChat(chatId, userId) {
      selectedChatId = chatId;
      selectedReceiverId = userId;
      document.getElementById('message-input-area').style.display = 'flex';
      
      // Load existing messages via WebSocket
      socket.emit('load-messages', { userId })
    }

    function updateChatListItem(userId, lastMessage) {
      // Find the chat item for this user and update it
      const chatItems = document.querySelectorAll('.chat-item')
      
      chatItems.forEach(item => {
        // Check if this chat item is for the given user
        const chatItemOnclick = item.getAttribute('onclick')
        if (chatItemOnclick && chatItemOnclick.includes(`'${userId}'`)) {
          const lastMessageElement = item.querySelector('.last-message')
          if (lastMessageElement) {
            lastMessageElement.textContent = lastMessage
          }
        }
      })
    }

    function displayMessages(messages, userId) {
      const chatWindow = document.getElementById('chat-window');
      
      if (messages && messages.length > 0) {
        let html = '';
        messages.forEach(msg => {
          const isOwn = msg.senderId === currentUser.id;
          const date = new Date(msg.createdAt).toLocaleString('nl-NL');
          html += `
            <div class="message ${isOwn ? 'own-message' : 'other-message'}">
              <p>${escapeHtml(msg.text)}</p>
              <span class="message-time">${date}</span>
            </div>
          `;
        });
        chatWindow.innerHTML = html;
      } else {
        chatWindow.innerHTML = '<div class="no-messages">Geen berichtjes in deze chat. Begin een conversatie!</div>';
      }
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function appendMessage(message, isOwn) {
      const chatWindow = document.getElementById('chat-window');
      
      // Clear empty state if present
      const emptyState = chatWindow.querySelector('.empty-state');
      const noMessages = chatWindow.querySelector('.no-messages');
      if (emptyState) emptyState.remove();
      if (noMessages) noMessages.remove();
      
      const date = new Date(message.createdAt).toLocaleString('nl-NL');
      const messageHtml = `
        <div class="message ${isOwn ? 'own-message' : 'other-message'}">
          <p>${escapeHtml(message.text)}</p>
          <span class="message-time">${date}</span>
        </div>
      `;
      
      chatWindow.innerHTML += messageHtml;
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function sendMessage(event) {
      event.preventDefault();
      
      const messageInput = document.getElementById('message-input');
      const text = messageInput.value.trim();
      
      if (!text || !selectedReceiverId) return;

      // Send message via WebSocket
      socket.emit('send-message', {
        chatId: selectedChatId,
        receiverId: selectedReceiverId,
        text: text
      })

      messageInput.value = '';
      messageInput.focus()
    }

    // Send typing indicator
    document.getElementById('message-input').addEventListener('input', () => {
      if (!isTyping && selectedReceiverId) {
        isTyping = true
        socket.emit('user-typing', { receiverId: selectedReceiverId })
      }
    })

    // Send stop typing after 1 second of inactivity
    let typingTimeout
    document.getElementById('message-input').addEventListener('input', () => {
      clearTimeout(typingTimeout)
      typingTimeout = setTimeout(() => {
        if (isTyping && selectedReceiverId) {
          isTyping = false
          socket.emit('user-stop-typing', { receiverId: selectedReceiverId })
        }
      }, 1000)
    })

    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    document.getElementById('logout-btn').addEventListener('click', () => {
      fetch('/logout', { method: 'POST' })
        .then(() => window.location.href = '/login')
        .catch(err => console.error('Logout error:', err));
    });

    // Error handling
    socket.on('error', (data) => {
      console.error('WebSocket error:', data.message)
      alert('Error: ' + data.message)
    })

    socket.on('disconnect', () => {
      console.log('âœ— Disconnected from WebSocket server')
    })
  </script>
</body>
</html>
